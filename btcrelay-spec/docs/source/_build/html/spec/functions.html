

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Functions: Storage and Verification &mdash; Polkadot BTC-Relay 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Functions: Utils" href="helpers.html" />
    <link rel="prev" title="Data Model" href="data-model.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: grey" >
          

          
            <a href="../index.html" class="icon icon-home"> Polkadot BTC-Relay
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/at-a-glance.html">BTC-Relay at a Glance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/bitcoin.html">Bitcoin Data Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/architecture.html">BTC-Relay Architecture</a></li>
</ul>
<p class="caption"><span class="caption-text">Specification</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="data-model.html">Data Model</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Functions: Storage and Verification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#initialize">initialize</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#specification">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#preconditions">Preconditions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#function-sequence">Function sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#storemainchainblockheader">storeMainChainBlockHeader</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id3">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#user-story">User Story</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">Function sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#storeforkblockheader">storeForkBlockHeader</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">User Story</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">Function Sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#verifyblockheader">verifyBlockHeader</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id10">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">User Story</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">Function Sequence</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#verifytransaction">verifyTransaction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id14">Specification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id15">User Story</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id18">Function Sequence</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="helpers.html">Functions: Utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="parser.html">Functions: Parser</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="errors.html">Error Codes</a></li>
</ul>
<p class="caption"><span class="caption-text">Security and Performance</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/security.html">Security Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security_performance/performance.html">Performance and Costs</a></li>
</ul>
<p class="caption"><span class="caption-text">All the rest</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other/license.html">License</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Polkadot BTC-Relay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Functions: Storage and Verification</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/spec/functions.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="functions-storage-and-verification">
<span id="storage-verification"></span><h1>Functions: Storage and Verification<a class="headerlink" href="#functions-storage-and-verification" title="Permalink to this headline">¶</a></h1>
<div class="section" id="initialize">
<span id="id1"></span><h2>initialize<a class="headerlink" href="#initialize" title="Permalink to this headline">¶</a></h2>
<p>Initializes BTC-Relay with the first Bitcoin block to be tracked and initializes all data structures (see <a class="reference internal" href="data-model.html#data-model"><span class="std std-ref">Data Model</span></a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>BTC-Relay <strong>does not</strong> have to be initialized with Bitcoin’s genesis block! The first block to be tracked can be selected freely.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Caution when setting the first block in BTC-Relay: only succeeding blocks can be submitted and <strong>predecessors will be rejected</strong>!</p>
</div>
<div class="section" id="specification">
<h3>Specification<a class="headerlink" href="#specification" title="Permalink to this headline">¶</a></h3>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">initialize(blockHeaderBytes,</span> <span class="pre">blockHeight)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>: raw Bitcoin block header bytes (80 bytes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">blockHeight</span></code>: Bitcoin block height of the submitted block header</p></li>
</ul>
<p><em>Returns</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: if initialization is executed correctly (and for the first time only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> (or throws exception): otherwise.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Initialized(blockHeight,</span> <span class="pre">blockHash)</span></code>: if the first block header was stored successfully, emit an event with the stored block’s height (<code class="docutils literal notranslate"><span class="pre">blockHeight</span></code>) and the (PoW) block hash (<code class="docutils literal notranslate"><span class="pre">blockHash</span></code>).</p></li>
</ul>
<p><em>Errors</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_ALREADY_INITIALIZED</span></code> = “Already initialized.”: raise exception if this function is called after BTC-Relay has already been initialized.</p></li>
</ul>
<p><em>Substrate</em></p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">blockHeaderBytes</span>: <span class="nc">T</span>::<span class="n">BTCBlockHeader</span><span class="p">,</span><span class="w"> </span><span class="n">blockHeight</span>: <span class="nc">U256</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{...}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="preconditions">
<h3>Preconditions<a class="headerlink" href="#preconditions" title="Permalink to this headline">¶</a></h3>
<p>This function is only called once, when BTC-Relay is being deployed.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Calls to <code class="docutils literal notranslate"><span class="pre">initialize</span></code> will likely be restricted through the governance mechanism of the BTC Parachain. This is to be defined.</p>
</div>
</div>
<div class="section" id="function-sequence">
<h3>Function sequence<a class="headerlink" href="#function-sequence" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">initialize</span></code> function takes as input an 80 byte raw Bitcoin block header and the corresponding Bitcoin block height, and follows the sequence below:</p>
<ol class="arabic simple">
<li><p>Check if <code class="docutils literal notranslate"><span class="pre">initialize</span></code> is called for the first time. This can be done by checking if <code class="docutils literal notranslate"><span class="pre">BestBlock</span> <span class="pre">==</span> <span class="pre">None</span></code>.</p>
<ol class="loweralpha simple">
<li><p>Raise <code class="docutils literal notranslate"><span class="pre">ERR_ALREADY_INITIALIZED</span></code> if BTC-Relay has already been initialized.</p></li>
</ol>
</li>
<li><p>Parse <code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>, extracting the <code class="docutils literal notranslate"><span class="pre">merkleRoot</span></code> using <a href="#id23"><span class="problematic" id="id24">`sha256d`_</span></a> , and store the block header data in <code class="docutils literal notranslate"><span class="pre">BlockHeaders</span></code>.</p></li>
<li><p>Compute the Bitcoin block hash (<code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code>) of the block header (use <code class="docutils literal notranslate"><span class="pre">sha256d(blockHeaderBytes)</span></code>) and store it as an entry in <code class="docutils literal notranslate"><span class="pre">MainChain</span></code> using the provided <code class="docutils literal notranslate"><span class="pre">blockHeight</span></code> as key.</p></li>
<li><p>Set <code class="docutils literal notranslate"><span class="pre">BestBlock</span> <span class="pre">=</span> <span class="pre">hashCurrentBlock</span></code> and <code class="docutils literal notranslate"><span class="pre">BestBlockHeight</span> <span class="pre">=</span> <span class="pre">blockHeight</span></code>.</p></li>
<li><p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Attention: the Bitcoin block header submitted to <code class="docutils literal notranslate"><span class="pre">initialize</span></code> must be in the Bitcoin main chain - this must be checked outside of the BTC Parachain <strong>before</strong> making this function call! A wrong initialization will cause the entire BTC Parachain to fail, since verification requires that all submitted blocks <strong>must</strong> (indirectly) point to the initialized block (i.e., have it as ancestor, just like the actual Bitcoin genesis block).</p>
</div>
</div>
</div>
<div class="section" id="storemainchainblockheader">
<span id="id2"></span><h2>storeMainChainBlockHeader<a class="headerlink" href="#storemainchainblockheader" title="Permalink to this headline">¶</a></h2>
<p>Method to submit block headers to the BTC-Relay, which extend the Bitcoin main chain (as tracked in <code class="docutils literal notranslate"><span class="pre">MainChain</span></code> in the BTC-Relay).
This function calls the <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code> proving the 80 bytes Bitcoin block header as input, and, if the latter returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, extracts from the block header and stores (i) the hash, height and Merkle tree root of the given block header in <code class="docutils literal notranslate"><span class="pre">BlockHeaders</span></code> and (ii) the hash and block height in <code class="docutils literal notranslate"><span class="pre">MainChain</span></code>.</p>
<div class="section" id="id3">
<h3>Specification<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader(blockHeaderBytes)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>: raw Bitcoin block header bytes (80 bytes).</p></li>
</ul>
<p><em>Returns</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: if <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code> returns <code class="docutils literal notranslate"><span class="pre">True</span></code> and the extraction and storage of the block header data was executed correctly.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> (or throws exception): otherwise.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">StoreMainChainHeader(blockHeight,</span> <span class="pre">blockHash)</span></code>: if the block header was stored successfully, emit an event with the stored block’s height (<code class="docutils literal notranslate"><span class="pre">blockHeight</span></code>) and the (PoW) block hash (<code class="docutils literal notranslate"><span class="pre">blockHash</span></code>).</p></li>
</ul>
<p><em>Errors</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_NOT_MAIN_CHAIN</span></code> = “Main chain submission indicated, but submitted block is on a fork”: raise exception if the block header submission indicates that it is extending the current longest chain, but is actually on a (new) fork.</p></li>
</ul>
<p><em>Substrate</em></p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">storeMainChainBlockHeader</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">blockHeaderBytes</span>: <span class="nc">T</span>::<span class="n">BTCBlockHeader</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{...}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="user-story">
<h3>User Story<a class="headerlink" href="#user-story" title="Permalink to this headline">¶</a></h3>
<p>A user calls the <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code> function when submitting a new Bitcoin block header to the BTC-Relay.
Thereby, the user performes the following steps:</p>
<ol class="arabic simple">
<li><p>The user checks that the to-be-submitted Bitcoin block header in part of the longest (main) chain <em>tracked by the BTC-Relay</em>.</p></li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The BTC-Relay does not necessarily have the same view of the Bitcoin blockchain as the user’s local Bitcoin client. This can happen if (i) the BTC-Relay is under attack (see <a class="reference external" href="TODO">Relay Poisoning</a>), (ii) the BTC-Relay is out of sync (see <a class="reference external" href="TODO">Relay Freshness</a>), or, similarly, (iii) if the user’s local Bitcoin client is under attack or out of sync.</p>
</div>
<ol class="arabic" start="2">
<li><p>The user calls the function passing an 80 byte block header (<code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>) and receives one of two possible results:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: the block header was successfully verified and stored.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: if verification fails (see exceptions raised for reason).</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The 80 bytes block header can be retrieved from the <a class="reference external" href="https://en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list">bitcoin-rpc client</a> by calling the <a class="reference external" href="https://bitcoin-rpc.github.io/en/doc/0.17.99/rpc/blockchain/getblock/">getBlock</a> and settign verbosity to <code class="docutils literal notranslate"><span class="pre">0</span></code> (<code class="docutils literal notranslate"><span class="pre">getBlock</span> <span class="pre">&lt;blockHash&gt;</span> <span class="pre">0</span></code>).</p>
</div>
</div>
<div class="section" id="id4">
<h3>Function sequence<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code> function takes as input the 80 byte raw Bitcoin block header and follows the following sequence:</p>
<ol class="arabic">
<li><p>Check that the submitted block header is extending the <code class="docutils literal notranslate"><span class="pre">MainChain</span></code> of BTC-Relay. That is, <code class="docutils literal notranslate"><span class="pre">hashPrevBlock</span></code> (extract using <code class="docutils literal notranslate"><span class="pre">extractHashPrevBlock(blockHeaderBytes)</span></code>) must be equal to <code class="docutils literal notranslate"><span class="pre">BestBlock</span></code>.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Raise <code class="docutils literal notranslate"><span class="pre">ERR_NOT_MAIN_CHAIN</span></code> error if this check fails.</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">verifyTransaction(blockHeaderBytes)</span></code>.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>If this call <strong>does not return</strong> <code class="docutils literal notranslate"><span class="pre">True</span></code> (i.e., fails or returns <code class="docutils literal notranslate"><span class="pre">False</span></code>), then abort and return <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ol>
</div></blockquote>
</li>
<li><p>Store the <code class="docutils literal notranslate"><span class="pre">height</span></code> and <code class="docutils literal notranslate"><span class="pre">merkleRoot</span></code> of the block header in the <code class="docutils literal notranslate"><span class="pre">blockHeaders</span></code> map, using <code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> as key.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> is the double SHA256 hash over the 80 bytes block header and can be calculated by calling <code class="docutils literal notranslate"><span class="pre">sha256d(blockHeaderBytes)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">merkleRoot</span></code> is the root of the transaction Merkle tree of the block header. Use <code class="docutils literal notranslate"><span class="pre">extractMerkleRoot(blockHeaderBytes)</span></code> to extract from block header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">height</span></code> is the blockchain height of the submitted block header. Compute by incrementing the height of the block header referenced by <code class="docutils literal notranslate"><span class="pre">hashPrevBlock</span></code> (retrieve from <code class="docutils literal notranslate"><span class="pre">BlockHeaders</span></code> using <code class="docutils literal notranslate"><span class="pre">hashPrevBlock</span></code> as key).</p></li>
</ul>
</div></blockquote>
</li>
</ol>
<ol class="arabic simple" start="3">
<li><p>Emit a <code class="docutils literal notranslate"><span class="pre">StoreMainChainBlockHeader</span></code> event using <code class="docutils literal notranslate"><span class="pre">height</span></code> and <code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> as input (<code class="docutils literal notranslate"><span class="pre">StoreMainChainHeader(height,</span> <span class="pre">hashCurrentBlock)</span></code>).</p></li>
<li><p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ol>
<div class="figure align-default" id="id19">
<img alt="storeMainChainBlockHeader sequence diagram" src="../_images/storeMainChainBlockHeader-sequence.png" />
<p class="caption"><span class="caption-text">Sequence diagram showing the function sequence of <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code>.</span><a class="headerlink" href="#id19" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="storeforkblockheader">
<span id="id5"></span><h2>storeForkBlockHeader<a class="headerlink" href="#storeforkblockheader" title="Permalink to this headline">¶</a></h2>
<p>Method to submit block headers to the BTC-Relay, which extend an existing of create a new <em>fork</em> (as tracked in <code class="docutils literal notranslate"><span class="pre">Forks</span></code> in the BTC-Relay).
This function calls the <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code> proving the 80 bytes Bitcoin block header as input, and, if the latter returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, extracts from the block header and stores (i) the hash, height and Merkle tree root of the given block header in <code class="docutils literal notranslate"><span class="pre">BlockHeaders</span></code> and (ii) the hash of the block header as well as the starting block height of the fork and the current lenght (1 if a new fork) in <code class="docutils literal notranslate"><span class="pre">forks</span></code>.</p>
<div class="section" id="id6">
<h3>Specification<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">storeForkHeader(blockHeaderBytes,</span> <span class="pre">forkId)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>: raw Bitcoin block header bytes (80 bytes).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forkId</span></code>: if block header is on a fork, specifies which fork is being extended (or being newly created).</p></li>
</ul>
<p><em>Returns</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: if the block header passes all checks and extends new or extends an existing fork of the currenlty known longest chain</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: otherwise.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">StoreForkHeader(forkId,</span> <span class="pre">blockHeight,</span> <span class="pre">blockHash)</span></code>: if the submitted block header is on a fork, emit an event with the fork’s id (<code class="docutils literal notranslate"><span class="pre">forkId</span></code>), block height (<code class="docutils literal notranslate"><span class="pre">blockHeight</span></code>) and the (PoW) block hash (<code class="docutils literal notranslate"><span class="pre">blockHash</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ChainReorg(newChainTip,</span> <span class="pre">startHeight,</span> <span class="pre">forkId)</span></code>: if the submitted block header on a fork results in a reorganization (fork longer than current main chain), emit an event with the block hash of the new highest block (<code class="docutils literal notranslate"><span class="pre">newChainTip</span></code>), the start block height of the fork (<code class="docutils literal notranslate"><span class="pre">startHeight</span></code>) and the fork identifier (<code class="docutils literal notranslate"><span class="pre">forkId</span></code>).</p></li>
</ul>
<p><em>Errors</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_FORK_PREV_BLOCK</span></code> = “Previous block hash does not match last block in fork submission”: raise exception if the block header does not reference the heighest block in the fork specified by <code class="docutils literal notranslate"><span class="pre">forkId</span></code> (via <code class="docutils literal notranslate"><span class="pre">prevBlockHash</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_NOT_FORK</span></code> = “Indicated fork submission, but block is in main chain”:  raise exception if the block header creates a new or extends an existing fork, but is actually extending the current longest chain.</p></li>
</ul>
<p><em>Substrate</em></p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">storeForkBlockHeader</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">blockHeaderBytes</span>: <span class="nc">T</span>::<span class="n">BTCBlockHeader</span><span class="p">,</span><span class="w"> </span><span class="n">forkId</span>: <span class="nc">U256</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{...}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id7">
<h3>User Story<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>A user calls the <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code> function when submitting a new Bitcoin block header, which is not extending the tip of the <code class="docutils literal notranslate"><span class="pre">MainChain</span></code> tracked in BTC-Relay.
Thereby, the user performes the following steps (see notes and warnings in <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code>):</p>
<ol class="arabic">
<li><p>The user checks that the to-be-submitted Bitcoin block header in <strong>not part</strong> of the longest (main) chain <em>tracked by the BTC-Relay</em>.</p></li>
<li><p>If the block header is on an existing <em>fork tracked by the BTC-Relay</em>, the user looks up the <code class="docutils literal notranslate"><span class="pre">forkId</span></code> in <code class="docutils literal notranslate"><span class="pre">Forks</span></code> in the BTC-Relay. If it is a new fork, specify <code class="docutils literal notranslate"><span class="pre">-1</span></code> as <code class="docutils literal notranslate"><span class="pre">forkId</span></code> (or other pre-defined value) - BTC-Relay will then create a new entry in <code class="docutils literal notranslate"><span class="pre">Forks</span></code> and assign a new <code class="docutils literal notranslate"><span class="pre">forkId</span></code> when storing the block header.</p></li>
<li><p>The user calls the function passing an 80 byte block header (<code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>) and receives one of two possible results:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: the block header was successfully verified and stored as a fork.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: if verification fails (see exceptions raised for reason).</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<hr class="docutils" />
<p><strong>Detection and Tracking of Forks</strong>:
Blockchain reorganizations or forks which occur on Bitcoin are detected and set up for tracking when a block header is submitted whose block height is lower than the currently tracked main chain height.</p>
</div>
<div class="section" id="id8">
<h3>Function Sequence<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code> function takes as input the 80 byte raw Bitcoin block header and a <code class="docutils literal notranslate"><span class="pre">forkId</span></code> and follows the following sequence:</p>
<ol class="arabic">
<li><p>Call <code class="docutils literal notranslate"><span class="pre">verifyTransaction(blockHeaderBytes)</span></code>.</p>
<ol class="loweralpha simple">
<li><p>If this call <strong>does not return</strong> <code class="docutils literal notranslate"><span class="pre">True</span></code> (i.e., fails or returns <code class="docutils literal notranslate"><span class="pre">False</span></code>), then abort and return <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
</ol>
</li>
<li><p>Check if <code class="docutils literal notranslate"><span class="pre">forkId</span> <span class="pre">==</span> <span class="pre">-1</span></code>.</p>
<blockquote>
<div><ol class="loweralpha">
<li><p>If <code class="docutils literal notranslate"><span class="pre">forkId</span> <span class="pre">==</span> <span class="pre">-1</span></code>, generate a new <code class="docutils literal notranslate"><span class="pre">forkId</span></code> and create a new entry in <code class="docutils literal notranslate"><span class="pre">Forks</span></code>, setting the <code class="docutils literal notranslate"><span class="pre">heigh</span></code> of the block header as the <code class="docutils literal notranslate"><span class="pre">startHeight</span></code> of the fork.</p></li>
<li><p>Otherwise:</p>
<blockquote>
<div><p>b.1 Check if a fork is tracked in <code class="docutils literal notranslate"><span class="pre">Forks</span></code> under the specified <code class="docutils literal notranslate"><span class="pre">forkId</span></code>. If no fork can be found, raise an <code class="docutils literal notranslate"><span class="pre">ERR_INVALID_FORK_ID</span></code> exception and abort.</p>
<p>b.2 Check that the <code class="docutils literal notranslate"><span class="pre">hashPrevBlock</span></code> of the submitted block header indeed references the last block submitted to the fork specified by <code class="docutils literal notranslate"><span class="pre">forkId</span></code> (use <code class="docutils literal notranslate"><span class="pre">getLastForkHash(forkId)</span></code>). Raise <code class="docutils literal notranslate"><span class="pre">ERR_FORK_PREV_BLOCK</span></code> exception and abort if this check fails.</p>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</li>
<li><p>Store the <code class="docutils literal notranslate"><span class="pre">height</span></code> and <code class="docutils literal notranslate"><span class="pre">merkleRoot</span></code> of the block header in the <code class="docutils literal notranslate"><span class="pre">blockHeaders</span></code> map, using <code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> as key.</p></li>
<li><p>Update <code class="docutils literal notranslate"><span class="pre">Fork[forkId]</span></code> entry, incrementing the fork <code class="docutils literal notranslate"><span class="pre">length</span></code> and inserting <code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> into the list of block hashes contained in that fork (<code class="docutils literal notranslate"><span class="pre">forkBlockHashes</span></code>).</p></li>
<li><p>Emit a <code class="docutils literal notranslate"><span class="pre">StoreForkBlockHeader</span></code> event using <code class="docutils literal notranslate"><span class="pre">height</span></code> and <code class="docutils literal notranslate"><span class="pre">hashCurrentBlock</span></code> as input (<code class="docutils literal notranslate"><span class="pre">StoreMainChainHeader(height,</span> <span class="pre">hashCurrentBlock)</span></code>).</p></li>
<li><p>Check if the fork at <code class="docutils literal notranslate"><span class="pre">forkId</span></code> has become longer than the current <code class="docutils literal notranslate"><span class="pre">MainChain</span></code>. This is the case if the block height <code class="docutils literal notranslate"><span class="pre">height</span></code> of the submitted block header exceeds the <code class="docutils literal notranslate"><span class="pre">BestBlockHeight</span></code>.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">height</span> <span class="pre">&gt;</span> <span class="pre">BestBlockHeight</span></code> call <code class="docutils literal notranslate"><span class="pre">chainReorg(forkId)</span></code> and return the value returned form this call.</p></li>
<li><p>Otherwise return <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
<ol class="arabic simple" start="4">
<li><p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
</ol>
<div class="figure align-default" id="id20">
<img alt="storeForkBlockHeader sequence diagram" src="../_images/storeForkBlockHeader-sequence.png" />
<p class="caption"><span class="caption-text">Sequence diagram showing the function sequence of <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code>.</span><a class="headerlink" href="#id20" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="verifyblockheader">
<span id="id9"></span><h2>verifyBlockHeader<a class="headerlink" href="#verifyblockheader" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code> function parses and verifies Bitcoin block
headers.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This function must called and return <code class="docutils literal notranslate"><span class="pre">True</span></code> <strong>before</strong>  a Bitcoin block header is stored in the BTC-Relay (i.e., must be called by the <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code> and <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code> functions).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function does not check whether the submitted block header extends the main chain or a fork. This check is performed in <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code> and <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code> respectively.</p>
</div>
<p>Other operations, such as verification of transaction inclusion, can only be executed once a block header has been verified and conseauently stored in the BTC-Relay.</p>
<div class="section" id="id10">
<h3>Specification<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h3>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">verifyBlockHeader(blockHeaderBytes)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code>: raw Bitcoin block header bytes (80 bytes).</p></li>
</ul>
<p><em>Returns</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: if the block header passes all checks.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> (or throws exception): otherwise.</p></li>
</ul>
<p><em>Errors</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_INVALID_FORK_ID</span></code> = “Incorrect fork identifier.”: raise an exception when a non-existent fork identifiert or <code class="docutils literal notranslate"><span class="pre">0</span></code> (blocked for special meaning) is passed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_INVALID_HEADER_SIZE</span></code> = “Invalid block header size”: raise exception if the submitted block header is not exactly 80 bytes long.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_DUPLICATE_BLOCK</span></code> = “Block already stored”: raise exception if the submitted block header is already stored in the BTC-Relay (same PoW <code class="docutils literal notranslate"><span class="pre">blockHash</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_PREV_BLOCK</span></code> = “Previous block hash not found”: raise an exception if the submitted block does not reference an already stored block header as predecessor (via <code class="docutils literal notranslate"><span class="pre">prevBlockHash</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_LOW_DIFF</span></code> = “PoW hash does not meet difficulty target of header”: raise exception when the header’s <code class="docutils literal notranslate"><span class="pre">blockHash</span></code> does not meet the <code class="docutils literal notranslate"><span class="pre">target</span></code> specified in the block header.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_DIFF_TARGET_HEADER</span></code> = “Incorrect difficulty target specified in block header”: raise exception if the <code class="docutils literal notranslate"><span class="pre">target</span></code> specified in the block header is incorrect for its block height (difficulty re-target not executed).</p></li>
</ul>
<p><em>Substrate</em></p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">verifyBlockHeader</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">blockHeaderBytes</span>: <span class="nc">T</span>::<span class="n">BTCBlockHeader</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{...}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id11">
<h3>User Story<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<p>This function is called from both <code class="docutils literal notranslate"><span class="pre">storeMainChainBlockHeader</span></code> and <code class="docutils literal notranslate"><span class="pre">storeForkBlockHeader</span></code>, but (typically) not by the user directly.
Optionally, a user can call this function and submit an 80 byte Bitcoin block header.</p>
<p>The caller of this function receives as return value:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: the block header was successfully verified</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> (or an exceptin is raised): if verification fails</p></li>
</ol>
</div></blockquote>
<hr class="docutils" />
<p><strong>Verification of Transaction Inclusion</strong>:
To be able to verify that a transaction is included in the Bitcoin blockchain, the corresponding block at the specified <code class="docutils literal notranslate"><span class="pre">txBlockHeight</span></code> must be first submitted, verified and stored in the BTC-Relay via <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code>.</p>
</div>
<div class="section" id="id12">
<h3>Function Sequence<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code> function takes as input the 80 byte raw Bitcoin block header and follows the following sequence:</p>
<ol class="arabic simple">
<li><p>Check that the <code class="docutils literal notranslate"><span class="pre">blockHeaderBytes</span></code> are 80 bytes long. Raise <code class="docutils literal notranslate"><span class="pre">ERR_INVALID_HEADER_SIZE</span></code> exception and abort otherwise.</p></li>
<li><p>Check that the block header is not yet stored in the BTC-Relay (<code class="docutils literal notranslate"><span class="pre">blockHash</span></code> is unique in <code class="docutils literal notranslate"><span class="pre">blockHeaders</span></code>). Raise <code class="docutils literal notranslate"><span class="pre">ERR_DUPLICATE_BLOCK</span></code> exception and abort otherwise.</p></li>
<li><p>Check that the previous block referenced by the submitted block header (<code class="docutils literal notranslate"><span class="pre">hashPrevBlock</span></code>) exists in <code class="docutils literal notranslate"><span class="pre">BlockHeaders</span></code>. Raise <code class="docutils literal notranslate"><span class="pre">ERR_PREV_BLOCK</span></code> exception adn abort otherwise.</p></li>
<li><p>Check that the Proof-of-Work hash (<code class="docutils literal notranslate"><span class="pre">blockHash</span></code>) is below the <code class="docutils literal notranslate"><span class="pre">target</span></code> specified in the block header. Raise <code class="docutils literal notranslate"><span class="pre">ERR_LOW_DIFF</span></code> exception and abort otherwise.</p></li>
<li><p>Check that the <code class="docutils literal notranslate"><span class="pre">target</span></code> specified in the block header is correct by calling <code class="docutils literal notranslate"><span class="pre">correctTarget(hashPrevBlock,</span> <span class="pre">height,</span> <span class="pre">target)</span></code> (as per Bitcoin’s difficulty adustment mechanism, see <a class="reference external" href="https://github.com/bitcoin/bitcoin/blob/78dae8caccd82cfbfd76557f1fb7d7557c7b5edb/src/pow.cpp">here</a>). If this call returns <code class="docutils literal notranslate"><span class="pre">False</span></code>, raise <code class="docutils literal notranslate"><span class="pre">ERR_DIFF_TARGET_HEADER</span></code> exception and abort.</p></li>
<li><p>Return <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
</ol>
<div class="figure align-default" id="id21">
<img alt="verifyBlockHeader sequence diagram" src="../_images/verifyBlockHeader-sequence.png" />
<p class="caption"><span class="caption-text">Sequence diagram showing the function sequence of <code class="docutils literal notranslate"><span class="pre">verifyBlockHeader</span></code>.</span><a class="headerlink" href="#id21" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="verifytransaction">
<span id="id13"></span><h2>verifyTransaction<a class="headerlink" href="#verifytransaction" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">verifyTransaction</span></code> function is one of the core components of the BTC-Relay:
this function returns whether a given transaction is valid by considering a number of parameters.
The core idea is that a user submits a transaction hash including the parameters to proof to another party that  the transaction is included in the Bitcoin blockchain.
Since the verification is based on the data in the BTC-Relay, other parties can rely on the trustworthiness of such a proof.</p>
<div class="section" id="id14">
<h3>Specification<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h3>
<p><em>Function Signature</em></p>
<p><code class="docutils literal notranslate"><span class="pre">verifyTransaction(txId,</span> <span class="pre">txBlockHeight,</span> <span class="pre">txIndex,</span> <span class="pre">merkleProof)</span></code></p>
<p><em>Parameters</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">txId</span></code>: the hash of the transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">txBlockHeight</span></code>: block height at which transaction is supposedly included.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">txIndex</span></code>: index of transaction in the block’s tx Merkle tree.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">merkleProof</span></code>: Merkle tree path (concatenated LE sha256 hashes).</p></li>
</ul>
<p><em>Returns</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: if txId is at the claimed position in the block at the given txBlockHeight.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: otherwise.</p></li>
</ul>
<p><em>Events</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">VerifyTransaction(txId,</span> <span class="pre">txBlockHeight,</span> <span class="pre">result)</span></code>: issue an event for a given txId and a blockHeight and return the result of the verification (either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p></li>
</ul>
<p><em>Errors</em></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_INVALID_TXID</span> <span class="pre">=</span> <span class="pre">&quot;Invalid</span> <span class="pre">transaction</span> <span class="pre">identifier&quot;</span></code>: raise an exception when the transaction id (<code class="docutils literal notranslate"><span class="pre">txId</span></code>) is malformed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_CONFIRMATIONS</span> <span class="pre">=</span> <span class="pre">&quot;Transaction</span> <span class="pre">has</span> <span class="pre">less</span> <span class="pre">confirmations</span> <span class="pre">than</span> <span class="pre">requested&quot;</span></code>: raise an exception when the number of confirmations is less than required.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERR_MERKLE_PROOF</span> <span class="pre">=</span> <span class="pre">&quot;Invalid</span> <span class="pre">Merkle</span> <span class="pre">Proof</span> <span class="pre">structure&quot;</span></code>: raise an exception when the Merkle proof is malformed.</p></li>
</ul>
<p><em>Substrate</em></p>
<div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="k">fn</span> <span class="nf">verifyTransaction</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span><span class="w"> </span><span class="n">txId</span>: <span class="nc">T</span>::<span class="n">Hash</span><span class="p">,</span><span class="w"> </span><span class="n">txBlockHeight</span>: <span class="nc">U256</span><span class="p">,</span><span class="w"> </span><span class="n">txIndex</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">merkleProof</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span> <span class="p">{...}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="id15">
<h3>User Story<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h3>
<p>Generally, a user has to follow four steps to successfully verify a transaction:</p>
<ol class="arabic">
<li><p>The user ensures that the Bitcoin block header, in which his transaction is included, is stored in the BTCRelay (see <a class="reference internal" href="#verifyblockheader">verifyBlockHeader</a>).</p></li>
<li><p>The user ensures that the block has the minimum number of required confirmations (typically <code class="docutils literal notranslate"><span class="pre">6</span></code>).</p></li>
<li><p>The user prepares the necessary input parameters from the Bitcoin blockchain to call the <code class="docutils literal notranslate"><span class="pre">verifyTransaction</span></code> function. The user can receive these parameters from the <a class="reference external" href="https://en.bitcoin.it/wiki/Original_Bitcoin_client/API_calls_list">bitcoin-rpc client</a>.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>The <em>transaction hash</em> is the transaction that should be verified. The user should note the transaction hash when sending a Bitcoin transaction he wants to verify.</p></li>
<li><p>The <em>block height</em> refers to the block in which the transaction is included. The user receives the block height from the <a class="reference external" href="https://bitcoin-rpc.github.io/en/doc/0.17.99/rpc/rawtransactions/getrawtransaction/">getrawtransaction</a> <code class="docutils literal notranslate"><span class="pre">bitcoin-rpc</span></code> method by querying for his transaction hash and receiving the <code class="docutils literal notranslate"><span class="pre">blockindex</span></code>.</p></li>
<li><p>The <em>transaction index</em> specifies the index of the transaction in the block. The user receives the index from the <code class="docutils literal notranslate"><span class="pre">bitcoin-rpc</span></code> method <a class="reference external" href="https://bitcoin-rpc.github.io/en/doc/0.17.99/rpc/blockchain/getblock/">getblock</a> by geting the index from the <code class="docutils literal notranslate"><span class="pre">tx</span></code> array storing the all transaction hashes in that block.</p></li>
<li><p>The <em>Merkle proof</em> encodes how to calculate the Merkle root from the transaction hash. The user receives the proof from the <code class="docutils literal notranslate"><span class="pre">bitcoin-rpc</span></code> method <a class="reference external" href="https://bitcoin-rpc.github.io/en/doc/0.17.99/rpc/blockchain/gettxoutproof/">gettxoutproof</a>.</p></li>
</ol>
</div></blockquote>
</li>
<li><p>The user submits the above parameters to the <code class="docutils literal notranslate"><span class="pre">verifyTransaction</span></code> function and receives one of two possible results.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">True</span></code>: the transaction is successfully verified.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code>: the transaction cannot be verified given the input parameters provided by the user.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="id18">
<h3>Function Sequence<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">verifyTransaction</span></code> function takes four inputs and follows the following sequence to verify if a transaction is valid:</p>
<ol class="arabic simple">
<li><p>The <em>transaction hash</em> (<code class="docutils literal notranslate"><span class="pre">txId</span></code>) needs to be 32 bytes long. If this condition is not met, the <code class="docutils literal notranslate"><span class="pre">ERR_INVALID_TXID</span></code> error is raised.</p></li>
<li><p>The submitted <em>block height</em> (<code class="docutils literal notranslate"><span class="pre">txBlockHeight</span></code>) is stored in BTCRelay and the block in which the transaction is included has enough confirmations. This check ensures that the submitted <em>block height</em> has at least the required amount of previous blocks (default <code class="docutils literal notranslate"><span class="pre">6</span></code>). Raises <code class="docutils literal notranslate"><span class="pre">ERR_CONFIRMATIONS</span></code> if the condition is not met.</p></li>
<li><p>The user submitted a valid <em>Merkle proof</em>. The Merkle proof needs to contain the <em>transaction hash</em> in its first 32 bytes. Further, the last hash in the Merkle proof must be the block header hash in which the transaction is included. If this condition is not met, the function raises an <code class="docutils literal notranslate"><span class="pre">ERR_MERKLE_PROOF</span></code> error.</p></li>
<li><p>The <em>Merkle proof</em> must be either 32 bytes long if the block contains only the coinbase transaction, or be above 64 bytes if the block contains more than one transaction. If this condition is not met, the function raises an <code class="docutils literal notranslate"><span class="pre">ERR_MERKLE_PROOF</span></code> error.</p></li>
<li><p>Last, the function calls the <code class="docutils literal notranslate"><span class="pre">computeMerkle</span></code> helper function to calculate the Merkle root. If <code class="docutils literal notranslate"><span class="pre">computeMerkle</span></code> returns the merkleRoot, the function returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, otherwise <code class="docutils literal notranslate"><span class="pre">False</span></code>. On completion of the function the <code class="docutils literal notranslate"><span class="pre">VerifyTransaction</span></code> event is generated including the transaction hash (<code class="docutils literal notranslate"><span class="pre">txId</span></code>), the block height (<code class="docutils literal notranslate"><span class="pre">txBlockHeight</span></code>), and the result (either <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>).</p></li>
</ol>
<div class="figure align-default" id="id22">
<img alt="verifyTransaction sequence diagram" src="../_images/verifyTransaction-sequence.png" />
<p class="caption"><span class="caption-text">The steps to verify a transaction in the <code class="docutils literal notranslate"><span class="pre">verifyTransaction</span></code> function.</span><a class="headerlink" href="#id22" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="helpers.html" class="btn btn-neutral float-right" title="Functions: Utils" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="data-model.html" class="btn btn-neutral float-left" title="Data Model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Interlay

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>